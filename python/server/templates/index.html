<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CJJ Trailer Data Viewer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <h1>CJJ Trailer Data Viewer</h1>
    <h2>Available Trailers</h2>
    <table>
        <thead>
            <tr>
                <th>Trailer Number</th>
                <th>Latest Log Timestamp</th>
                <th>Latest Alarm</th>
            </tr>
        </thead>
        <tbody>
            {% for trl in trl_list %}
                {% set latest_entry = trl_data[trl][-1] if trl in trl_data and trl_data[trl] else None %}
                <tr>
                    <td><a href="#" onclick="loadData('{{ trl }}')">{{ trl }}</a></td>
                    <td>{{ latest_entry["timestamp"].strftime('%Y-%m-%d %H:%M:%S') if latest_entry else 'N/A' }}</td>
                    <td>
                        {% if latest_entry and "alarm_codes" in latest_entry and latest_entry["alarm_codes"] %}
                            {{ latest_entry["alarm_codes"] | join(', ') }}
                        {% else %}
                            No Alarms
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="data-container">
        <h2>Trailer Data</h2>
        <button id="download-btn">Download Excel</button>
        <div id="download-message">Getting download ready...</div>
        <div id="command-buttons" style="margin: 10px 0;">
            <!-- Buttons will be shown/hidden dynamically -->
            <button id="reset-alarm-btn">Reset Alarm</button>
            <button id="defrost-btn">Defrost</button>
            <div id="command-status"></div>
        </div>
        <table id="trl-data-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Setpoint</th>
                    <th>Return Temp</th>
                    <th>Supply Temp</th>
                    <th>Coil Temp</th>
                    <th>Fan</th>
                    <th>Compressor</th>
                    <th>Electric Heater</th>
                    <th>Valve</th>
                    <th>Status</th>
                    <th>Alarm Codes</th>
                </tr>
            </thead>
            <tbody id="trl-data-body">
                <tr><td colspan="11">Click on a TRL number to view data.</td></tr>
            </tbody>
        </table>
    </div>
    <script>
        let selectedTrl = null;

        function loadData(trl) {
            selectedTrl = trl;
            document.querySelector("#data-container h2").textContent = `Trailer Data for ${trl}`;
            document.getElementById("command-buttons").style.display = "block";

            fetch(`/trl/${trl}`)
                .then(response => response.json())
                .then(data => {
                    data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    let tableBody = document.getElementById('trl-data-body');
                    tableBody.innerHTML = "";

                    if (data.length === 0) {
                        tableBody.innerHTML = "<tr><td colspan='11'>No data available.</td></tr>";
                        return;
                    }

                    // Get the latest entry
                    const latestEntry = data[0];

                    // Update button visibility based on conditions
                    const resetBtn = document.getElementById("reset-alarm-btn");
                    const defrostBtn = document.getElementById("defrost-btn");

                    // Show alarm reset button only if there are active alarms
                    resetBtn.style.display =
                        latestEntry.alarm_codes && latestEntry.alarm_codes.length > 0 ? "inline-block" : "none";

                    // Show defrost button only if coil temp is below 45F
                    defrostBtn.style.display =
                        latestEntry.coil_temp !== undefined && latestEntry.coil_temp < 45 ? "inline-block" : "none";

                    // Rest of your existing table population code
                    data.forEach(entry => {
                        let formattedTimestamp = new Date(entry.timestamp)
                            .toISOString()
                            .replace("T", " ")
                            .slice(0, -5);

                        let row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${formattedTimestamp}</td>
                            <td>${entry.setpoint}</td>
                            <td>${entry.return_temp}</td>
                            <td>${entry.supply_temp}</td>
                            <td>${entry.coil_temp}</td>
                            <td>${String(entry.fan).toLowerCase() === "true" ? 'ON' : 'OFF'}</td>
                            <td>${String(entry.compressor).toLowerCase() === "true" ? 'ON' : 'OFF'}</td>
                            <td>${String(entry.electric_heater).toLowerCase() === "true" ? 'ON' : 'OFF'}</td>
                            <td>${String(entry.valve).toLowerCase() === "true" ? 'OPEN' : 'CLOSED'}</td>
                            <td>${entry.status}</td>
                            <td>${entry.alarm_codes && entry.alarm_codes.length ? entry.alarm_codes.join(', ') : 'No Alarms'}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                    document.getElementById("download-btn").style.display = "inline-block";
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function updateTrailerList() {
            fetch("/")
                .then(response => response.text())
                .then(html => {
                    let parser = new DOMParser();
                    let doc = parser.parseFromString(html, "text/html");
                    let newTableBody = doc.querySelector("table tbody").innerHTML;
                    document.querySelector("table tbody").innerHTML = newTableBody;
                    sortTable();
                })
                .catch(error => console.error("Error updating trailer list:", error));
        }

        // Refresh trailer list every 10 seconds
        setInterval(updateTrailerList, 10000);

    </script>
    <script>
        document.getElementById("download-btn").addEventListener("click", function() {
            if (selectedTrl) {
                let message = document.getElementById("download-message");
                message.style.display = "block";

                setTimeout(() => {
                    message.style.display = "none";
                    window.location.href = `/download/${selectedTrl}`;
                }, 4000);
            }
        });
        document.getElementById("reset-alarm-btn").addEventListener("click", function() {
            if (selectedTrl) {
                sendCommand(selectedTrl, "alarm_reset");
                const resetBtn = document.getElementById("reset-alarm-btn");
                resetBtn.style.display = "none";
            }
        });

        document.getElementById("defrost-btn").addEventListener("click", function() {
            if (selectedTrl) {
                sendCommand(selectedTrl, "defrost");
                    const defrostBtn = document.getElementById("defrost-btn");

                    defrostBtn.style.display = "none";
            }
        });

        function sendCommand(trl, command) {
            fetch(`/command/${trl}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({command: command})
            })
            .then(response => response.json())
            .then(data => {
                let statusDiv = document.getElementById("command-status");
                statusDiv.textContent = `Command ${command} sent to ${trl}`;
                statusDiv.style.display = "block";
                setTimeout(() => statusDiv.style.display = "none", 3000);
            })
            .catch(error => {
                console.error('Error sending command:', error);
            });
        }
        function sortTable() {
            let table = document.querySelector("table tbody");
            let rows = Array.from(table.rows);

            rows.sort((a, b) => {
                let dateA = new Date(a.cells[1].textContent.trim());
                let dateB = new Date(b.cells[1].textContent.trim());
                return dateB - dateA; // Sort descending (newest first)
            });

            // Reattach sorted rows
            table.innerHTML = "";
            rows.forEach(row => table.appendChild(row));
        }

        // Automatically sort table when page loads
        window.onload = function () {
            sortTable(); // Sort table when page loads
        };
    </script>

</body>
</html>
