<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refrigeration Data Viewer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <h1>Refrigeration Data Viewer</h1>
    <h2>Available Units</h2>
    <table>
        <thead>
            <tr>
                <th>Unit Number</th>
                <th>Latest Log Timestamp</th>
                <th>Latest Alarm</th>
            </tr>
        </thead>
        <tbody id="unit-list-body">
            <!-- Units will be populated dynamically by JavaScript -->
        </tbody>
    </table>

    <div id="data-container">
        <h2>Unit Data</h2>
        <button id="download-btn">Download Excel</button>
        <div id="download-message">Getting download ready...</div>
        <div id="command-buttons" style="margin: 10px 0;">
            <!-- Buttons will be shown/hidden dynamically -->
            <button id="reset-alarm-btn">Reset Alarm</button>
            <button id="defrost-btn">Defrost</button>
            <div id="command-status"></div>
        </div>
        <table id="unit-data-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Setpoint</th>
                    <th>Return Temp</th>
                    <th>Supply Temp</th>
                    <th>Coil Temp</th>
                    <th>Fan</th>
                    <th>Compressor</th>
                    <th>Electric Heater</th>
                    <th>Valve</th>
                    <th>Status</th>
                    <th>Alarm Codes</th>
                </tr>
            </thead>
            <tbody id="unit-data-body">
                <tr><td colspan="11">Click on a Unit number to view data.</td></tr>
            </tbody>
        </table>
    </div>
    <script>
        let selectedUnit = null;

        function loadData(unit) {
            selectedUnit = unit;
            document.querySelector("#data-container h2").textContent = `Unit Data for ${unit}`;
            document.getElementById("command-buttons").style.display = "block";

            fetch(`/unit/${unit}`)
                .then(response => response.json())
                .then(data => {
                    data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    let tableBody = document.getElementById('unit-data-body');
                    tableBody.innerHTML = "";

                    if (data.length === 0) {
                        tableBody.innerHTML = "<tr><td colspan='11'>No data available.</td></tr>";
                        return;
                    }

                    // Get the latest entry
                    const latestEntry = data[0];

                    // Update button visibility based on conditions
                    const resetBtn = document.getElementById("reset-alarm-btn");
                    const defrostBtn = document.getElementById("defrost-btn");

                    // Show alarm reset button only if there are active alarms
                    resetBtn.style.display =
                        latestEntry.alarm_codes && latestEntry.alarm_codes.length > 0 ? "inline-block" : "none";

                    // Show defrost button only if coil temp is below 45F
                    defrostBtn.style.display =
                        latestEntry.coil_temp !== undefined && latestEntry.coil_temp < 45 ? "inline-block" : "none";

                    // Rest of your existing table population code
                    data.forEach(entry => {
                        let formattedTimestamp = new Date(entry.timestamp)
                            .toISOString()
                            .replace("T", " ")
                            .slice(0, -5);

                        let row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${formattedTimestamp}</td>
                            <td>${entry.setpoint}</td>
                            <td>${entry.return_temp}</td>
                            <td>${entry.supply_temp}</td>
                            <td>${entry.coil_temp}</td>
                            <td>${String(entry.fan).toLowerCase() === "true" ? 'ON' : 'OFF'}</td>
                            <td>${String(entry.compressor).toLowerCase() === "true" ? 'ON' : 'OFF'}</td>
                            <td>${String(entry.electric_heater).toLowerCase() === "true" ? 'ON' : 'OFF'}</td>
                            <td>${String(entry.valve).toLowerCase() === "true" ? 'OPEN' : 'CLOSED'}</td>
                            <td>${entry.status}</td>
                            <td>${entry.alarm_codes && entry.alarm_codes.length ? entry.alarm_codes.join(', ') : 'No Alarms'}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                    document.getElementById("download-btn").style.display = "inline-block";
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function updateUnitList() {
            fetch("/api/units")
                .then(response => response.json())
                .then(data => {
                    let tableBody = document.getElementById("unit-list-body");
                    tableBody.innerHTML = "";

                    if (data.units && data.units.length > 0) {
                        data.units.forEach(unit => {
                            let latestEntry = data.unit_data[unit] && data.unit_data[unit].length > 0
                                ? data.unit_data[unit][data.unit_data[unit].length - 1]
                                : null;

                            let row = document.createElement("tr");
                            let timestamp = 'N/A';
                            if (latestEntry && latestEntry.timestamp) {
                                // Parse timestamp in format "HH:MM:SS  MM:DD:YYYY"
                                // Example: "00:13:35  07:23:2025"
                                let parts = latestEntry.timestamp.split('  ');
                                if (parts.length === 2) {
                                    let time = parts[0].trim();
                                    let date = parts[1].trim();
                                    // Convert to ISO format: YYYY-MM-DDTHH:MM:SS
                                    let dateParts = date.split(':');
                                    if (dateParts.length === 3) {
                                        let isoString = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}T${time}`;
                                        let dateObj = new Date(isoString);
                                        if (!isNaN(dateObj.getTime())) {
                                            timestamp = dateObj.toLocaleString();
                                        } else {
                                            timestamp = latestEntry.timestamp;
                                        }
                                    } else {
                                        timestamp = latestEntry.timestamp;
                                    }
                                } else {
                                    timestamp = latestEntry.timestamp;
                                }
                            }
                            let alarms = latestEntry && latestEntry.alarm_codes && latestEntry.alarm_codes.length > 0
                                ? latestEntry.alarm_codes.join(', ')
                                : 'No Alarms';

                            row.innerHTML = `
                                <td><a href="#" onclick="loadData('${unit}')">${unit}</a></td>
                                <td>${timestamp}</td>
                                <td>${alarms}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        tableBody.innerHTML = "<tr><td colspan='3'>No units available</td></tr>";
                    }
                    sortTable();
                })
                .catch(error => console.error("Error updating unit list:", error));
        }

        // Refresh Unit list every 10 seconds
        setInterval(updateUnitList, 10000);

        // Load unit list on page load
        window.onload = function() {
            updateUnitList();
        };

    </script>
    <script>
        document.getElementById("download-btn").addEventListener("click", function() {
            if (selectedUnit) {
                let message = document.getElementById("download-message");
                message.style.display = "block";

                setTimeout(() => {
                    message.style.display = "none";
                    window.location.href = `/download/${selectedUnit}`;
                }, 4000);
            }
        });
        document.getElementById("reset-alarm-btn").addEventListener("click", function() {
            if (selectedUnit) {
                sendCommand(selectedUnit, "alarm_reset");
                const resetBtn = document.getElementById("reset-alarm-btn");
                resetBtn.style.display = "none";
            }
        });

        document.getElementById("defrost-btn").addEventListener("click", function() {
            if (selectedUnit) {
                sendCommand(selectedUnit, "defrost");
                const defrostBtn = document.getElementById("defrost-btn");

                    defrostBtn.style.display = "none";
            }
        });

        function sendCommand(unit, command) {
            fetch(`/command/${unit}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({command: command})
            })
            .then(response => response.json())
            .then(data => {
                let statusDiv = document.getElementById("command-status");
                statusDiv.textContent = `Command ${command} sent to ${unit}`;
                statusDiv.style.display = "block";
                setTimeout(() => statusDiv.style.display = "none", 3000);
            })
            .catch(error => {
                console.error('Error sending command:', error);
            });
        }
        function sortTable() {
            let table = document.querySelector("#unit-list-body");
            let rows = Array.from(table.rows);

            rows.sort((a, b) => {
                let dateA = new Date(a.cells[1].textContent.trim());
                let dateB = new Date(b.cells[1].textContent.trim());
                return dateB - dateA; // Sort descending (newest first)
            });

            // Reattach sorted rows
            table.innerHTML = "";
            rows.forEach(row => table.appendChild(row));
        }

        // Load unit list on page load
        window.onload = function() {
            updateUnitList();
        };
    </script>

</body>
</html>
